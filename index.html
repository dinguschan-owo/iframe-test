<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site 2: Render Page</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: auto;
        }
    </style>
</head>
<body>
    <script>
        async function getParameterByName(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function fetchAndReplace(url) {
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const htmlContent = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');

                // Fetch and replace external CSS
                const cssLinks = doc.querySelectorAll('link[rel="stylesheet"]');
                const cssPromises = Array.from(cssLinks).map(async (link) => {
                    const cssUrl = link.href.startsWith('http') ? link.href : new URL(link.href, url).href;
                    const cssResponse = await fetch(cssUrl);
                    const cssContent = await cssResponse.text();
                    return { href: cssUrl, content: cssContent };
                });

                // Fetch and replace external JavaScript
                const jsScripts = doc.querySelectorAll('script[src]');
                const jsPromises = Array.from(jsScripts).map(async (script) => {
                    const jsUrl = script.src.startsWith('http') ? script.src : new URL(script.src, url).href;
                    const jsResponse = await fetch(jsUrl);
                    const jsContent = await jsResponse.text();
                    return { src: jsUrl, content: jsContent };
                });

                // Wait for all CSS and JS fetching to complete
                const cssResults = await Promise.all(cssPromises);
                const jsResults = await Promise.all(jsPromises);

                // Replace external CSS links with inline styles
                cssResults.forEach(({ href, content }) => {
                    const styleTag = `<style>${content}</style>`;
                    htmlContent = htmlContent.replace(`<link href="${href}" rel="stylesheet">`, styleTag);
                });

                // Replace external JS scripts with inline scripts
                jsResults.forEach(({ src, content }) => {
                    const scriptTag = `<script>${content}</script>`;
                    htmlContent = htmlContent.replace(`<script src="${src}"></script>`, scriptTag);
                });

                // Update document body with modified content
                document.body.innerHTML = htmlContent;

                // Append any remaining inline scripts
                const remainingScripts = doc.querySelectorAll('script:not([src])');
                remainingScripts.forEach(script => {
                    const inlineScript = document.createElement('script');
                    inlineScript.textContent = script.textContent;
                    document.body.appendChild(inlineScript);
                });

            } catch (error) {
                console.error('Error fetching and processing content:', error);
                document.body.innerHTML = `<h1>Failed to load content from ${url}</h1>`;
            }
        }

        (async function() {
            const url = await getParameterByName('url');
            if (url) {
                await fetchAndReplace(url);
            } else {
                document.body.innerHTML = '<h1>No URL provided</h1>';
            }
        })();
    </script>
</body>
</html>
