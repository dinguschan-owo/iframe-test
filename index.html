<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website 2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body id="content">
    <script>
        const url = new URLSearchParams(window.location.search).get('url');
        const proxies = [
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://api.codetabs.com/v1/tmp/?quest=',
            'https://api.allorigins.win/raw?url='
        ];
        let proxyIndex = 0;

        async function fetchWithProxy() {
            if (proxyIndex >= proxies.length) {
                document.body.innerHTML = 'Error: Could not fetch the website content after multiple attempts.';
                return;
            }

            const proxy = proxies[proxyIndex];
            const fetchUrl = proxy + encodeURIComponent(url);

            try {
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');

                // Handle internal and external CSS files
                const linkElements = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
                const cssPromises = linkElements.map(async link => {
                    const href = new URL(link.getAttribute('href'), url).href;
                    const cssContent = await fetchResource(href);
                    const style = document.createElement('style');
                    style.textContent = cssContent;
                    document.head.appendChild(style); // Append CSS to head
                });

                // Handle internal and external JS files
                const scriptElements = Array.from(doc.querySelectorAll('script[src]'));
                const jsPromises = scriptElements.map(async script => {
                    const src = new URL(script.getAttribute('src'), url).href;
                    const jsContent = await fetchResource(src);
                    const newScript = document.createElement('script');
                    newScript.textContent = jsContent;
                    document.body.appendChild(newScript); // Append JS to body
                });

                // Handle external resources like fonts, icons, etc.
                const externalResources = [];
                linkElements.forEach(link => {
                    if (link.getAttribute('href').startsWith('http')) {
                        externalResources.push(fetchAndInjectExternalResource(link.getAttribute('href'), 'css'));
                    }
                });

                scriptElements.forEach(script => {
                    if (script.getAttribute('src').startsWith('http')) {
                        externalResources.push(fetchAndInjectExternalResource(script.getAttribute('src'), 'js'));
                    }
                });

                // Wait for all CSS, JS, and external resources to be fetched and injected
                await Promise.all([...cssPromises, ...jsPromises, ...externalResources]);

                // Inject the modified HTML into the current document
                document.open();
                document.write(doc.documentElement.outerHTML);
                document.close();

                // Re-fetch CSS and JS for custom elements
                refetchExternalResources(doc);

            } catch (error) {
                console.error('Fetch error:', error);
                proxyIndex++;
                fetchWithProxy();
            }
        }

        async function fetchResource(resourceUrl) {
            try {
                const proxyUrl = proxies[proxyIndex] + encodeURIComponent(resourceUrl);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.text();
            } catch (error) {
                throw new Error('Failed to fetch resource: ' + resourceUrl);
            }
        }

        async function fetchAndInjectExternalResource(resourceUrl, type) {
            try {
                const proxyUrl = proxies[proxyIndex] + encodeURIComponent(resourceUrl);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const content = await response.text();

                if (type === 'css') {
                    const style = document.createElement('style');
                    style.textContent = content;
                    document.head.appendChild(style);
                } else if (type === 'js') {
                    const script = document.createElement('script');
                    script.textContent = content;
                    document.body.appendChild(script);
                }
            } catch (error) {
                console.error('Failed to fetch external resource:', resourceUrl, error);
                proxyIndex++;
                fetchWithProxy();
            }
        }

        // Re-fetch CSS and JS for custom elements
        async function refetchExternalResources(doc) {
            const linkElements = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
            const scriptElements = Array.from(doc.querySelectorAll('script[src]'));

            linkElements.forEach(link => {
                if (link.getAttribute('href').startsWith('http')) {
                    fetchAndInjectExternalResource(link.getAttribute('href'), 'css');
                }
            });

            scriptElements.forEach(script => {
                if (script.getAttribute('src').startsWith('http')) {
                    fetchAndInjectExternalResource(script.getAttribute('src'), 'js');
                }
            });
        }

        if (url) {
            fetchWithProxy();
        } else {
            document.body.innerText = 'No URL provided.';
        }
    </script>
</body>
</html>
